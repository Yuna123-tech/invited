<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-DEAL ì—°êµ¬íšŒ ì›Œí¬ìˆ ì´ˆëŒ€ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .card-bg { background-color: #f7f9fb; background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .invitation-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-gradient { background-image: linear-gradient(to right, #667eea 0%, #764ba2 51%, #667eea 100%); transition: 0.5s; background-size: 200% auto; }
        .btn-gradient:hover { background-position: right center; }
    </style>
</head>
<body class="card-bg">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        <div class="invitation-card p-6 sm:p-8 rounded-2xl shadow-2xl">
            
            <div class="text-center mb-8">
                <h2 class="font-playfair text-gray-500 text-xl">You are Invited</h2>
                <h1 class="font-playfair text-5xl font-bold text-gray-800 mt-2">G-DEAL Workshop</h1>
                <p class="text-gray-600 mt-4">ì„ ìƒë‹˜ë“¤ì„ ì†Œì¤‘í•œ ì›Œí¬ìˆì— ì´ˆëŒ€í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="flex flex-col sm:flex-row justify-around text-center border-y-2 border-dashed border-gray-300 py-6 mb-8">
                <div class="mb-4 sm:mb-0">
                    <h3 class="font-bold text-lg text-gray-700">ğŸ“… ë‚ ì§œ ë° ì‹œê°„</h3>
                    <p class="text-gray-600">2025ë…„ 8ì›” 30ì¼(í† ) ~ 31ì¼(ì¼)</p>
                    <p class="text-gray-600">ì˜¤í›„ 1:00 ~ 5:00</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-gray-700">ğŸ“ ì¥ì†Œ</h3>
                    <p class="text-gray-600">ì´ìˆœì‹ ë¦¬ë”ì‹­êµ­ì œì„¼í„°</p>
                    <p class="text-sm text-gray-500">(ê²½ë‚¨ ì°½ì›ì‹œ ì§„í•´êµ¬ ì¶©ì¥ë¡œ 633)</p>
                </div>
            </div>

            <div id="admin-panel" class="hidden mb-8 p-4 bg-red-100 border border-red-300 rounded-lg">
                <h3 class="font-bold text-lg text-red-800 text-center">ê´€ë¦¬ì íŒ¨ë„</h3>
                <p class="text-center text-red-700 mb-2">í˜„ì¬ ìƒíƒœ: <span id="selection-status" class="font-bold"></span></p>
                <button id="toggle-selection-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    ìƒíƒœ ë³€ê²½
                </button>
            </div>
<!-- â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ì—¬ê¸°ì„œë¶€í„° ë³µì‚¬ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ -->
<!-- ì›Œí¬ìˆ ì¼ì • ì„¹ì…˜ -->
<div class="mb-12">
    <h2 class="text-3xl font-playfair font-bold text-center mb-6 text-gray-800">ğŸ—“ï¸ Workshop Schedule</h2>
    <div class="rounded-xl shadow-lg overflow-hidden border border-gray-200 bg-white">
        <table class="w-full text-sm text-left text-gray-700">
            <thead class="text-xs text-gray-800 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 w-1/6 text-center">ì¼ì</th>
                    <th scope="col" class="px-6 py-3 w-1/4 text-center">ì‹œê°„</th>
                    <th scope="col" class="px-6 py-3">ì£¼ìš” ë‚´ìš©</th>
                </tr>
            </thead>
            <tbody>
                <!-- 1ì¼ì°¨ -->
                <tr class="border-b">
                    <td rowspan="8" class="px-6 py-4 font-bold text-center align-middle bg-gray-50">1ì¼ì°¨</td>
                    <td class="px-6 py-4 font-mono text-center">12:30-13:00</td>
                    <td class="px-6 py-4">ëŒ€ê´€ ì‹œì‘, ì¤€ë¹„ ë° ë“±ë¡</td>
                </tr>
                <tr class="bg-gray-50 border-b">
                    <td class="px-6 py-4 font-mono text-center">13:00-13:40</td>
                    <td class="px-6 py-4">ë””ì§€í„¸ ë‚˜ëˆ” ê²Œì„ 1ì°¨ì „</td>
                </tr>
                <tr class="border-b">
                    <td class="px-6 py-4 font-mono text-center">13:50-14:30</td>
                    <td class="px-6 py-4">ë””ì§€í„¸ ë‚˜ëˆ” ê²Œì„ 2ì°¨ì „</td>
                </tr>
                <tr class="bg-gray-50 border-b">
                    <td class="px-6 py-4 font-mono text-center">14:40-15:30</td>
                    <td class="px-6 py-4">ì»¤ë®¤ë‹ˆí‹° íŒ€ë¹Œë”© ë“±</td>
                </tr>
                <tr class="border-b">
                    <td class="px-6 py-4 font-mono text-center">15:40-16:10</td>
                    <td class="px-6 py-4">G-DEAL í™ˆí˜ì´ì§€ ë°ëª¨ë²„ì „ ì†Œê°œ ë° í”¼ë“œí¬ì›Œë“œ</td>
                </tr>
                <tr class="bg-gray-50 border-b">
                    <td class="px-6 py-4 font-mono text-center">16:10-16:50</td>
                    <td class="px-6 py-4">G-DEAL í–¥í›„ ë°©í–¥ ì†Œê°œ ë° ë””ì§€í„¸êµìœ¡ë‚˜ëˆ”í•œë§ˆë‹¹ ê´€ë ¨ ì˜ê²¬ìˆ˜ë ´ ë“±</td>
                </tr>
                <tr class="border-b">
                    <td class="px-6 py-4 font-mono text-center">17:00-19:00</td>
                    <td class="px-6 py-4">ğŸ» ëŒ€íŒ¨ì‚¼ê²¹ì‚´ 1ì°¨ (ë’¤í’€ì´)</td>
                </tr>
                <tr class="bg-gray-50 border-b">
                    <td class="px-6 py-4 font-mono text-center">19:00~</td>
                    <td class="px-6 py-4">2ì°¨..?! ê°ì ìˆ™ì†Œë¡œ!</td>
                </tr>
                <!-- 2ì¼ì°¨ -->
                <tr class="border-b">
                    <td rowspan="4" class="px-6 py-4 font-bold text-center align-middle bg-gray-50">2ì¼ì°¨</td>
                    <td class="px-6 py-4 font-mono text-center">~ 10:00</td>
                    <td class="px-6 py-4">ì²´í¬ì•„ì›ƒ</td>
                </tr>
                <tr class="bg-gray-50 border-b">
                    <td class="px-6 py-4 font-mono text-center">10:00-11:00</td>
                    <td class="px-6 py-4">ğŸŒ ì•„ì¹¨ ì‹ì‚¬</td>
                </tr>
                <tr class="border-b">
                    <td class="px-6 py-4 font-mono text-center">11:00-12:30</td>
                    <td class="px-6 py-4">â˜• í•´ì¥ ì¹´í˜(?) ë° ììœ ì‹œê°„</td>
                </tr>
                <tr class="bg-gray-50 border-b">
                    <td class="px-6 py-4 font-mono text-center">12:30</td>
                    <td class="px-6 py-4">ğŸ‘‹ í•´ì‚°!</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<!-- â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ë³µì‚¬ â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² -->
            <div>
                <h2 class="text-3xl font-playfair font-bold text-center mb-4 text-gray-800">ğŸ Secret Manito</h2>
                <div id="auth-info" class="text-center mb-6 p-3 bg-indigo-100 border border-indigo-200 rounded-lg text-indigo-800">
                    <p>ë¡œê·¸ì¸ ì •ë³´ í™•ì¸ ì¤‘...</p>
                </div>
                
                <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">ë§ˆë‹ˆë˜ ì°¸ì—¬ ë°©ë²•</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-600">
                        <li>ë§ˆë‹ˆë˜ë¥¼ ìœ„í•´ <span class="font-bold text-purple-600">ì†Œì†Œí•˜ê³  ì‘ì€ ì„ ë¬¼</span>ì„ ë¯¸ë¦¬ ì¤€ë¹„í•´ì£¼ì„¸ìš”.</li>
                        <li>ì•„ë˜ì— <span class="font-bold">ìì‹ ì„ ë‚˜íƒ€ë‚´ëŠ” í•œ ì¤„ ì„¤ëª…</span>ê³¼ <span class="font-bold">ì¢‹ì•„í•˜ëŠ” ê¸€ê·€</span>ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. <br><span class="text-red-500 font-semibold">(â€» ë³¸ì¸ì˜ ì´ë¦„ì€ ì ˆëŒ€ë¡œ ë°íˆì‹œë©´ ì•ˆ ë¼ìš”!)</span></li>
                        <li>ë‹¤ë¥¸ ì„ ìƒë‹˜ì˜ ê¸€ì„ ì½ê³  ë§ˆìŒì´ ê°€ëŠ” ê¸€ì„ ì„ íƒí•˜ë©´, ê·¸ ë¶„ì˜ ë§ˆë‹ˆë˜ê°€ ë©ë‹ˆë‹¤. <br><span class="text-blue-600 font-semibold">(â€» ì„ íƒì€ ì›Œí¬ìˆ ë‹¹ì¼ ê´€ë¦¬ìê°€ ê¸°ëŠ¥ì„ ì—° í›„ì— ê°€ëŠ¥í•©ë‹ˆë‹¤!)</span></li>
                    </ol>
                </div>
                
                <div id="manito-form-container" class="mb-8">
                    <div class="space-y-4">
                        <div>
                            <label for="introduction" class="block text-sm font-medium text-gray-700">ë‚˜ë¥¼ ì†Œê°œí•˜ëŠ” í•œ ì¤„ (ì´ë¦„ ì œì™¸)</label>
                            <input type="text" id="introduction" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì˜ˆ: ì•„ì´ë“¤ê³¼ í•¨ê»˜ ì„±ì¥í•˜ëŠ” ê²ƒì„ ì¦ê¸°ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.">
                        </div>
                        <div>
                            <label for="quote" class="block text-sm font-medium text-gray-700">ì¢‹ì•„í•˜ëŠ” ê¸€ê·€ë‚˜ ëª…ì–¸</label>
                            <textarea id="quote" rows="3" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì˜ˆ: ë³„ì€ ë°”ë¼ë³´ëŠ” ìì—ê²Œ ë¹›ì„ ì¤€ë‹¤."></textarea>
                        </div>
                        <button id="submit-btn" class="w-full text-white font-bold py-3 px-4 rounded-md btn-gradient">
                            ì œì¶œí•˜ê¸°
                        </button>
                    </div>
                </div>

                <div>
                    <!-- â˜…â˜…â˜… ë°”ë¡œ ì´ ë¶€ë¶„ì´ ì´ì „ì— ëˆ„ë½ë˜ì—ˆë˜ HTML ì½”ë“œì…ë‹ˆë‹¤! â˜…â˜…â˜… -->
                    <!-- ë‚´ê°€ ì„ íƒí•œ ë§ˆë‹ˆë˜ í‘œì‹œ ì˜ì—­ -->
                    <div id="my-manito-display" class="hidden mb-6 p-4 bg-teal-100 border border-teal-300 rounded-lg">
                        <h3 class="text-xl font-bold text-center text-teal-800 mb-2 font-playfair">âœ¨ ë‹¹ì‹ ì€ ì´ ë¶„ì˜ ë¹„ë°€ ë§ˆë‹ˆë˜ì…ë‹ˆë‹¤ âœ¨</h3>
                        <div class="text-center bg-white p-3 rounded-md">
                            <p id="my-manito-introduction" class="text-sm text-gray-700 mb-2"></p>
                            <p id="my-manito-quote" class="font-serif text-lg italic text-teal-900"></p>
                        </div>
                    </div>
                    <!-- â˜…â˜…â˜… ì—¬ê¸°ê¹Œì§€ ì…ë‹ˆë‹¤ â˜…â˜…â˜… -->

                    <h3 class="text-2xl font-playfair font-bold text-center mb-2 text-gray-800">Choose Your Manito</h3>
                    <p class="text-center text-gray-500 mb-6">ë§ˆìŒì— ë“œëŠ” ê¸€ê·€ë¥¼ ì„ íƒí•´ ê·¸ ë¶„ì˜ ë§ˆë‹ˆë˜ê°€ ë˜ì–´ì£¼ì„¸ìš”. (ì„ íƒì€ ë‹¨ í•œ ë²ˆ!)</p>
                    <div id="entries-list" class="grid md:grid-cols-2 gap-4">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ìš© Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-600" id="modal-content"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close" class="w-full px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ìˆ˜ì •ìš© Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative p-6 border w-full max-w-lg shadow-lg rounded-2xl bg-white">
            <h3 class="text-xl font-bold text-gray-900 mb-4">ë‚´ ê¸€ ìˆ˜ì •í•˜ê¸°</h3>
            <div class="space-y-4">
                <div>
                    <label for="edit-introduction" class="block text-sm font-medium text-gray-700">ë‚˜ë¥¼ ì†Œê°œí•˜ëŠ” í•œ ì¤„</label>
                    <input type="text" id="edit-introduction" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="edit-quote" class="block text-sm font-medium text-gray-700">ì¢‹ì•„í•˜ëŠ” ê¸€ê·€ë‚˜ ëª…ì–¸</label>
                    <textarea id="edit-quote" rows="4" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
            </div>
            <div class="flex items-center justify-end mt-6 space-x-3">
                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none">
                    ì·¨ì†Œ
                </button>
                <button id="save-edit-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none">
                    ìˆ˜ì • ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // â˜…â˜…â˜… ì¤‘ìš” â˜…â˜…â˜… ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase ì„¤ì • ì •ë³´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
     const firebaseConfig = {
    apiKey: "AIzaSyA6pOWP9oihx4lz3gNxn2L-pAvABW5_-tk",
    authDomain: "g-deal-workshop.firebaseapp.com",
    projectId: "g-deal-workshop",
    storageBucket: "g-deal-workshop.firebasestorage.app",
    messagingSenderId: "987758429475",
    appId: "1:987758429475:web:21f05e790aed7c714e3896",
    measurementId: "G-GY1TXTYYY3"
        };
        // ===================================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ===================================================================================
        // â˜…â˜…â˜… ê´€ë¦¬ì ì„¤ì • â˜…â˜…â˜… ì—¬ê¸°ì— ê´€ë¦¬ì UIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!
        const ADMIN_UID = "9FzsNvxzohPQpcrsRTYzwID7MRi2"; 
        // ===================================================================================

        // --- DOM Elements ---
        const introductionInput = document.getElementById('introduction');
        const quoteInput = document.getElementById('quote');
        const submitBtn = document.getElementById('submit-btn');
        const entriesList = document.getElementById('entries-list');
        const authInfo = document.getElementById('auth-info');
        const manitoFormContainer = document.getElementById('manito-form-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalClose = document.getElementById('modal-close');
        const editModal = document.getElementById('edit-modal');
        const editIntroductionInput = document.getElementById('edit-introduction');
        const editQuoteInput = document.getElementById('edit-quote');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const adminPanel = document.getElementById('admin-panel');
        const selectionStatus = document.getElementById('selection-status');
        const toggleSelectionBtn = document.getElementById('toggle-selection-btn');

        // --- Global State ---
        let currentUser = null;
        let currentEntries = []; // ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
        let userHasSubmitted = false;
        let userHasSelected = false;
        let isSelectionOpen = false;
        let currentEditingDocId = null;

        // --- Functions ---
        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authInfo.innerHTML = `<p class="font-semibold">í™˜ì˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì˜ ê³ ìœ  ID: <span class="font-mono bg-indigo-200 px-2 py-1 rounded">${currentUser.uid}</span></p>`;
                if (currentUser.uid === ADMIN_UID) adminPanel.classList.remove('hidden');
                setupAdminControlsListener();
                setupEntriesListener();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    authInfo.textContent = 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.';
                }
            }
        });

        submitBtn.addEventListener('click', async () => {
            if (!currentUser || userHasSubmitted) {
                showModal('ì•Œë¦¼', userHasSubmitted ? 'ì´ë¯¸ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.' : 'ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const introduction = introductionInput.value.trim();
            const quote = quoteInput.value.trim();
            if (!introduction || !quote) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.');
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';
            try {
                await addDoc(collection(db, "manito-entries"), {
                    introduction, quote,
                    authorId: currentUser.uid,
                    selectedBy: null,
                    timestamp: serverTimestamp()
                });
                showModal('ì„±ê³µ', 'ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                showModal('ì˜¤ë¥˜', 'ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì œì¶œí•˜ê¸°';
            }
        });
        
        function setupAdminControlsListener() {
            onSnapshot(doc(db, "admin-controls", "settings"), (docSnap) => {
                isSelectionOpen = docSnap.exists() ? docSnap.data().selectionOpen : false;
                updateUIBasedOnSelectionState();
            });
        }

        function setupEntriesListener() {
            if (!currentUser) return;
            onSnapshot(collection(db, "manito-entries"), (snapshot) => {
                const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                entries.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                
                currentEntries = entries; // ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

                userHasSubmitted = entries.some(entry => entry.authorId === currentUser.uid);
                userHasSelected = entries.some(entry => entry.selectedBy === currentUser.uid);

                if (userHasSubmitted) {
                    manitoFormContainer.style.display = 'none';
                } else {
                    manitoFormContainer.style.display = 'block';
                }
                
                const myManitoDisplay = document.getElementById('my-manito-display');
                const myManitoIntroduction = document.getElementById('my-manito-introduction');
                const myManitoQuote = document.getElementById('my-manito-quote');

                const mySelection = entries.find(entry => entry.selectedBy === currentUser.uid);

                if (mySelection) {
                    myManitoIntroduction.textContent = `"${mySelection.introduction}"`;
                    myManitoQuote.textContent = `"${mySelection.quote}"`;
                    myManitoDisplay.classList.remove('hidden');
                } else {
                    myManitoDisplay.classList.add('hidden');
                }

                renderEntries(entries);
            });
        }
        
        function updateUIBasedOnSelectionState() {
            if (currentUser && currentUser.uid === ADMIN_UID) {
                selectionStatus.textContent = isSelectionOpen ? 'ì§„í–‰ ì¤‘' : 'ë§ˆê°';
                toggleSelectionBtn.textContent = isSelectionOpen ? 'ë§ˆë‹ˆë˜ ì„ íƒ ë§ˆê°í•˜ê¸°' : 'ë§ˆë‹ˆë˜ ì„ íƒ ì‹œì‘í•˜ê¸°';
            }
            renderEntries(currentEntries); // ì €ì¥ëœ ë°ì´í„°ë¡œ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        }
        
        function createEntryCard(entry) {
            const card = document.createElement('div');
            card.className = 'p-4 bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col justify-between transition-transform hover:scale-105';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-grow';
            contentDiv.innerHTML = `<p class="text-sm text-gray-500 mb-2">"${entry.introduction}"</p><p class="font-serif text-lg italic text-gray-800">"${entry.quote}"</p>`;
            card.appendChild(contentDiv);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-4 pt-4 border-t border-gray-100';

            const isAdmin = currentUser && currentUser.uid === ADMIN_UID;

            if (entry.authorId === currentUser.uid) {
                const canEdit = (!isSelectionOpen && !entry.selectedBy) || isAdmin;
                if (canEdit) {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'ìˆ˜ì •';
                    editBtn.className = 'w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-l-md transition duration-300';
                    editBtn.onclick = () => openEditModal(entry);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'ì‚­ì œ';
                    deleteBtn.className = 'w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-r-md transition duration-300';
                    deleteBtn.onclick = () => confirmDelete(entry.id);
                    buttonContainer.append(editBtn, deleteBtn);
                } else {
                    const status = document.createElement('p');
                    status.className = 'text-center text-blue-500 font-bold p-2 bg-blue-100 rounded-md';
                    status.textContent = 'ë‚´ê°€ ì“´ ê¸€';
                    buttonContainer.appendChild(status);
                }
            } else {
                if (entry.selectedBy) {
                    const status = document.createElement('p');
                    status.className = 'text-center text-red-500 font-bold p-2 bg-red-100 rounded-md';
                    status.textContent = 'ì„ì ìˆì–´ìš”';
                    buttonContainer.appendChild(status);
                } else if (isSelectionOpen && userHasSubmitted && !userHasSelected) {
                    const selectBtn = document.createElement('button');
                    selectBtn.textContent = 'ì´ ë¶„ì˜ ë§ˆë‹ˆë˜ ë˜ê¸°';
                    selectBtn.className = 'w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300';
                    selectBtn.onclick = () => selectManito(entry.id);
                    buttonContainer.appendChild(selectBtn);
                } else {
                    const status = document.createElement('p');
                    status.className = 'text-center text-gray-500 font-bold p-2 bg-gray-100 rounded-md';
                    if (!isSelectionOpen) status.textContent = 'ì„ íƒ ëŒ€ê¸° ì¤‘';
                    else if (!userHasSubmitted) status.textContent = 'ë¨¼ì € ê¸€ì„ ì œì¶œí•´ì£¼ì„¸ìš”';
                    else if (userHasSelected) status.textContent = 'ì„ íƒ ì™„ë£Œ';
                    else status.textContent = 'ì„ íƒ ë¶ˆê°€';
                    buttonContainer.appendChild(status);
                }
                if (isAdmin) {
                    const adminDeleteBtn = document.createElement('button');
                    adminDeleteBtn.textContent = 'ê´€ë¦¬ì ì‚­ì œ';
                    adminDeleteBtn.className = 'w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white text-xs font-bold py-1 px-2 rounded-md transition duration-300';
                    adminDeleteBtn.onclick = () => confirmDelete(entry.id);
                    buttonContainer.appendChild(adminDeleteBtn);
                }
            }
            card.appendChild(buttonContainer);
            return card;
        }

        function renderEntries(entries) {
            entriesList.innerHTML = '';
            entries.forEach(entry => {
                const card = createEntryCard(entry);
                entriesList.appendChild(card);
            });
        }

        async function selectManito(docId) {
            if (!isSelectionOpen || !userHasSubmitted || userHasSelected) {
                showModal('ì•Œë¦¼', 'ì§€ê¸ˆì€ ë§ˆë‹ˆë˜ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.');
                return;
            }
            try {
                await updateDoc(doc(db, "manito-entries", docId), { selectedBy: currentUser.uid });
                showModal('ì„±ê³µ!', 'ë§ˆë‹ˆë˜ ì„ íƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ëˆ„ê°€ ì£¼ì¸ê³µì¼ì§€ ê¸°ëŒ€ë˜ë„¤ìš”!');
            } catch (error) {
                showModal('ì˜¤ë¥˜', 'ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        toggleSelectionBtn.addEventListener('click', async () => {
            const newState = !isSelectionOpen;
            try {
                await setDoc(doc(db, "admin-controls", "settings"), { selectionOpen: newState });
                showModal('ì„±ê³µ', `ë§ˆë‹ˆë˜ ì„ íƒì„ ${newState ? 'ì‹œì‘' : 'ë§ˆê°'}í–ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                showModal('ì˜¤ë¥˜', 'ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        function openEditModal(entry) {
            currentEditingDocId = entry.id;
            editIntroductionInput.value = entry.introduction;
            editQuoteInput.value = entry.quote;
            editModal.classList.remove('hidden');
        }

        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
            currentEditingDocId = null;
        });

        saveEditBtn.addEventListener('click', async () => {
            const newIntroduction = editIntroductionInput.value.trim();
            const newQuote = editQuoteInput.value.trim();
            if (!newIntroduction || !newQuote) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.');
                return;
            }
            try {
                const entryRef = doc(db, "manito-entries", currentEditingDocId);
                await updateDoc(entryRef, {
                    introduction: newIntroduction,
                    quote: newQuote
                });
                editModal.classList.add('hidden');
                showModal('ì„±ê³µ', 'ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showModal('ì˜¤ë¥˜', 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        function confirmDelete(docId) {
            if (confirm('ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                deleteEntry(docId);
            }
        }

        async function deleteEntry(docId) {
            try {
                await deleteDoc(doc(db, "manito-entries", docId));
                showModal('ì„±ê³µ', 'ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showModal('ì˜¤ë¥˜', 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
